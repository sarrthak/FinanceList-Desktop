<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: update/JSONupdater.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: update/JSONupdater.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * This file is used once after updating from version 0.9.1 to version 1.0.0.
 * It simply makes sure, that all timestamps are unique (because this functionality was
 * missing in version 0.9.1).
 *
 * @module JSONupdater
 * @author Malte311
 */

const config = require( './scripts/config.js' );

/**
 * Loops through all available data and makes sure that every timestamp is unique.
 * Of course, partitioned entries keep the same timestamp.
 */
function createUniqueTimestamps() {
    var allFiles = getJSONFiles();
    var usedDates = [];
    var log = "";

    allFiles.forEach( function( file ) {
        if ( file != "mainStorage" ) {
            log += "Currently updating file " + file + "\r\n\r\n";
            var data = readJSONFile( readPreference( "path" ) + path.sep + file + ".json" );
            data = sortData( data ); // before this version the data was not sorted perfectly
            for ( var i = 0; i &lt; data.length; i++ ) {
                log += "Before: " + JSON.stringify( data[i] ) + "\r\n";
                for ( var j = 0; j &lt; usedDates.length; j++ ) {
                    if ( data[i].date === usedDates[j].date &amp;&amp; differentEntries(data[i], usedDates[j]) ) {
                        data[i].date = data[i].date + 1;
                    }
                }
                usedDates.push( data[i] );
                log += "After:  " + JSON.stringify( data[i] ) + "\r\n\r\n";
            }
            // Write back
            replaceData( file + ".json", data );
        }
    });
    log += "Finished!\r\n";
    log += "=====================================================================\r\n\r\n";

    if ( config.log ) {
        fs.appendFileSync( storage.getDefaultDataPath() + path.sep + "log.txt", log );
    }
}

/**
 * Returns if two entries are partitioned or different.
 * @param {JSON} e1 First entry
 * @param {JSON} e2 Second entry
 * @return {bool} True if the entries are different, false if they are partitioned
 */
function differentEntries( e1, e2 ) {
    return e1.date != e2.date ||
           e1.name != e2.name ||
           e1.type != e2.type ||
           e1.category != e2.category ||
           (e1.date == e2.date &amp;&amp;
           e1.budget == e2.budget);
}

var currentVersion = remote.app.getVersion();
var lastUpdate = readPreference( "versionUpdate" );
// Function call only once
if ( lastUpdate === undefined || lastUpdate &lt;= "1.0.0" ) {
    createUniqueTimestamps();
    storePreference( "versionUpdate", currentVersion );
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-balancesController.html">balancesController</a></li><li><a href="module-balancesView.html">balancesView</a></li><li><a href="module-config.html">config</a></li><li><a href="module-controller.html">controller</a></li><li><a href="module-electronMenu.html">electronMenu</a></li><li><a href="module-helpController.html">helpController</a></li><li><a href="module-indexController.html">indexController</a></li><li><a href="module-indexView.html">indexView</a></li><li><a href="module-JSONhandler.html">JSONhandler</a></li><li><a href="module-JSONupdater.html">JSONupdater</a></li><li><a href="module-pdfview.html">pdfview</a></li><li><a href="module-settingsController.html">settingsController</a></li><li><a href="module-settingsView.html">settingsView</a></li><li><a href="module-updates.html">updates</a></li><li><a href="module-view.html">view</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Fri Jan 03 2020 17:06:02 GMT+0000 (Greenwich Mean Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
